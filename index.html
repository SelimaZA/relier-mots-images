<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Relier images ‚Üî mots (clic-clic, pins align√©es, images ‚Äúcontain‚Äù)</title>
<style>
  :root{
    --gap:16px; --radius:16px; --shadow:0 6px 20px rgba(0,0,0,.08);
    --obj:#60a5fa;   /* bleu clair objets */
    --word:#f472b6;  /* rose clair mots   */
    --line:#4f46e5;  /* indigo lignes     */
    --ok:#10b981; --ko:#ef4444;
  }
  *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
  body{margin:0;background:#f6f8fb;color:#111827}
  .wrap{max-width:1100px;margin:auto;padding:20px}
  h1{font-size:20px;margin:0 0 14px}

  /* grille */
  .board{position:relative;display:grid;grid-template-columns:1fr 1fr;gap:var(--gap);align-items:start}
  .col{background:#fff;border-radius:var(--radius);padding:16px;box-shadow:var(--shadow)}
  .title{display:flex;align-items:center;gap:8px;margin:0 0 10px}
  .dot{width:10px;height:10px;border-radius:999px;display:inline-block}
  .dot.obj{background:var(--obj)} .dot.word{background:var(--word)}

  /* cartes */
  .list{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px}
  .card{
    position:relative;border-radius:14px;background:#fafafa;border:2px solid transparent;
    min-height:170px; display:flex; align-items:center; justify-content:center; padding:8px;
  }
  .card.obj{border-color:var(--obj); background:#f0f7ff}
  .card.word{border-color:var(--word); background:#fff0f6}

  /* image √† l‚Äôint√©rieur : pas de recadrage agressif */
  .card .img{
    width:100%; height:160px; object-fit:contain; background:#fff; border-radius:10px; display:block;
  }

  /* pastilles : toujours centr√©es verticalement sur les bords */
  .pin{
    position:absolute; top:50%; transform:translateY(-50%);
    width:18px; height:18px; border-radius:999px; background:var(--line);
    border:3px solid #fff; box-shadow:0 0 0 2px rgba(0,0,0,.08); cursor:pointer;
  }
  .pin.left{ left:-9px }   /* d√©passe un peu */
  .pin.right{ right:-9px }
  .pin.active{ box-shadow:0 0 0 4px rgba(79,70,229,.25) }

  /* calque lignes */
  svg#lines{position:absolute; inset:0; pointer-events:none}
  line.link{stroke:var(--line); stroke-width:3; stroke-linecap:round}
  circle.cap{fill:#fff; stroke:var(--line); stroke-width:2}

  /* barre actions */
  .row{display:flex; gap:10px; flex-wrap:wrap; margin-top:16px}
  button{border:0;border-radius:12px;padding:10px 14px;font-weight:700;box-shadow:var(--shadow);cursor:pointer}
  .primary{background:#4f46e5;color:#fff}
  .ghost{background:#e5e7eb}
  .ok{background:var(--ok);color:#fff}
  .ko{background:var(--ko);color:#fff}
  .msg{margin-left:auto;font-weight:700}
</style>
</head>
<body>
<div class="wrap">
  <h1>Relie chaque <u>image</u> au <u>bon mot</u> (clique les pastilles)</h1>

  <!-- ‚öôÔ∏è CONFIG : adapte juste ceci -->
  <script>
  const PAIRS = [
    // id = identifiant commun (sans espaces/accents)
    // imgObj  = photo objet (colonne gauche)
    // imgWord = image du mot (colonne droite)
    { id:"markabon",    imgObj:"assets/markabon_p.jpg",    imgWord:"assets/markabon.png" },
    { id:"mi7fathaton", imgObj:"assets/mi7fathaton_p.jpg", imgWord:"assets/mi7fathaton.png" },
    { id:"mou3alimaton",imgObj:"assets/mou3alimaton_p.jpg",imgWord:"assets/mou3alimaton.png" }
  ];
  </script>

  <div class="board" id="board">
    <svg id="lines" viewBox="0 0 100 100" preserveAspectRatio="none"></svg>

    <!-- OBJETS (gauche) -->
    <div class="col">
      <div class="title"><span class="dot obj"></span><strong>Images (objets)</strong></div>
      <div id="left" class="list"></div>
    </div>

    <!-- MOTS-IMAGES (droite) -->
    <div class="col">
      <div class="title"><span class="dot word"></span><strong>Mots (images)</strong></div>
      <div id="right" class="list"></div>
    </div>
  </div>

  <div class="row">
    <button id="check" class="primary">V√©rifier</button>
    <button id="reset" class="ghost">Recommencer</button>
    <div id="msg" class="msg"></div>
  </div>
</div>

<script>
/* ====== √©l√©ments & √©tat ====== */
const $board = document.getElementById('board');
const $lines = document.getElementById('lines');
const $left  = document.getElementById('left');
const $right = document.getElementById('right');
const map = new Map();          // wordId -> objId
const pins = new Map();         // key -> {type, id, pinEl}
let startPin = null;            // pastille de d√©part (clic 1)
let preview = null;             // ligne temporaire (aper√ßu)
let rafId = 0;

/* ====== helpers g√©om√©trie ====== */
function boardRect(){ return $board.getBoundingClientRect(); }
function center(el){
  const b = boardRect();
  const r = el.getBoundingClientRect();
  return { x: r.left - b.left + r.width/2, y: r.top - b.top + r.height/2 };
}
function setViewBoxToBoard(){
  const r = boardRect();
  $lines.setAttribute('viewBox', `0 0 ${r.width} ${r.height}`);
}

/* ====== rendu cartes ====== */
function makeCard(id, src, kind){ // kind: 'obj'|'word'
  const card = document.createElement('div');
  card.className = `card ${kind}`;
  const img = document.createElement('img');
  img.className = 'img';
  img.decoding = 'async';
  img.loading  = 'lazy';
  img.src = src; img.alt = id;
  const pin = document.createElement('button');
  pin.type='button';
  pin.className = 'pin ' + (kind==='obj' ? 'right' : 'left');
  pin.setAttribute('aria-label', `Point ${kind} ${id}`);
  card.append(img, pin);
  return {card, pin, img};
}

PAIRS.forEach(p=>{
  const {card, pin, img} = makeCard(p.id, p.imgObj, 'obj');
  $left.appendChild(card);
  pins.set(`obj:${p.id}`, {type:'obj', id:p.id, pinEl:pin});
  img.addEventListener('load', drawAll, {once:false});
});
PAIRS.slice().sort(()=>Math.random()-0.5).forEach(p=>{
  const {card, pin, img} = makeCard(p.id, p.imgWord, 'word');
  $right.appendChild(card);
  pins.set(`word:${p.id}`, {type:'word', id:p.id, pinEl:pin});
  img.addEventListener('load', drawAll, {once:false});
});

/* ====== interactions clic-clic ====== */
function pinKeyFromEl(el){
  for(const [k,v] of pins.entries()) if(v.pinEl===el) return k;
  return null;
}
function startPreview(fromEl){
  stopPreview();
  const L = document.createElementNS('http://www.w3.org/2000/svg','line');
  L.setAttribute('class','link');
  $lines.appendChild(L);
  preview = { line:L, fromEl, mouse:{x:0,y:0} };

  const move = (ev)=>{
    preview.mouse.x = ev.clientX; preview.mouse.y = ev.clientY;
    if(!rafId){
      rafId = requestAnimationFrame(()=>{
        rafId = 0;
        const a = center(fromEl);
        const bRect = boardRect();
        const b = { x: preview.mouse.x - bRect.left, y: preview.mouse.y - bRect.top };
        L.setAttribute('x1',a.x); L.setAttribute('y1',a.y);
        L.setAttribute('x2',b.x); L.setAttribute('y2',b.y);
      });
    }
  };
  preview.move = move;
  document.addEventListener('mousemove', move, {passive:true});
}
function stopPreview(){
  if(preview){
    document.removeEventListener('mousemove', preview.move);
    preview.line.remove();
    preview=null;
  }
}

pins.forEach(({pinEl})=>{
  pinEl.addEventListener('click', (e)=>{
    e.stopPropagation();
    const key = pinKeyFromEl(pinEl);
    const cur = pins.get(key);
    if(!startPin){
      // 1er clic
      startPin = cur;
      cur.pinEl.classList.add('active');
      startPreview(cur.pinEl);
      return;
    }
    // 2e clic
    if(startPin.type === cur.type){
      // m√™me colonne ‚Üí on red√©marre depuis ce point
      startPin.pinEl.classList.remove('active');
      startPin = cur;
      cur.pinEl.classList.add('active');
      startPreview(cur.pinEl);
      return;
    }
    // on relie (toujours word -> obj)
    const word = (startPin.type==='word') ? startPin : cur;
    const obj  = (startPin.type==='obj')  ? startPin : cur;
    map.set(word.id, obj.id);
    startPin.pinEl.classList.remove('active');
    startPin=null;
    stopPreview();
    drawAll();
  });
});

// annule la s√©lection si on clique ailleurs
document.addEventListener('click', ()=>{
  if(startPin){ startPin.pinEl.classList.remove('active'); startPin=null; stopPreview(); }
});

/* ====== dessin des liaisons ====== */
function drawAll(){
  setViewBoxToBoard();
  while($lines.firstChild) $lines.firstChild.remove();

  for(const [wordId,objId] of map.entries()){
    const w = pins.get(`word:${wordId}`)?.pinEl;
    const o = pins.get(`obj:${objId}` )?.pinEl;
    if(!w || !o) continue;
    const a = center(w), b = center(o);

    const L = document.createElementNS('http://www.w3.org/2000/svg','line');
    L.setAttribute('class','link');
    L.setAttribute('x1',a.x); L.setAttribute('y1',a.y);
    L.setAttribute('x2',b.x); L.setAttribute('y2',b.y);

    const c1 = document.createElementNS('http://www.w3.org/2000/svg','circle');
    c1.setAttribute('class','cap'); c1.setAttribute('cx',a.x); c1.setAttribute('cy',a.y); c1.setAttribute('r',6);
    const c2 = document.createElementNS('http://www.w3.org/2000/svg','circle');
    c2.setAttribute('class','cap'); c2.setAttribute('cx',b.x); c2.setAttribute('cy',b.y); c2.setAttribute('r',6);

    $lines.append(L,c1,c2);
  }
}

/* ====== v√©rifier & reset ====== */
const $msg = document.getElementById('msg');
document.getElementById('check').addEventListener('click', ()=>{
  let ok=0;
  PAIRS.forEach(p=>{ if(map.get(p.id)===p.id) ok++; });
  document.querySelectorAll('.card.obj').forEach(card=>{
    const id = card.querySelector('.pin').getAttribute('aria-label').split(' ').pop(); // fin = id
    const good = map.get(id)===id;
    card.style.borderColor = good ? 'var(--ok)' : 'var(--ko)';
  });
  $msg.textContent = (ok===PAIRS.length)? 'Bravo ! Tout est correct üéâ' : `${ok}/${PAIRS.length} correct(s)`;
  $msg.className = 'msg ' + (ok===PAIRS.length ? 'ok' : 'ko');
});

document.getElementById('reset').addEventListener('click', ()=>{
  map.clear();
  $msg.textContent=''; $msg.className='msg';
  document.querySelectorAll('.card').forEach(c=> c.style.borderColor='');
  stopPreview();
  if(startPin){ startPin.pinEl.classList.remove('active'); startPin=null; }
  drawAll();
});

/* ====== (re)calcul aux √©v√©nements ====== */
setViewBoxToBoard();
window.addEventListener('resize', ()=>{ drawAll(); });
window.addEventListener('scroll', ()=>{ drawAll(); }, {passive:true});
</script>
</body>
</html>
